<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Project</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <!-- Custom Tailwind Theme -->
    <script src="./static/js/theme.js"></script>
    <script src="./static/js/profileAction.js"></script>
    <script src="./static/js/confic.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
    <!-- FontAwesome for Icons -->
    <script src="https://kit.fontawesome.com/5d4c9f5ac8.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
</head>

<body class="flex bg-background w-screen">
    <div id="sidebar"></div>

    <div class="flex-1 w-full">
        <!-- Header -->
        <div id="header"></div>

        <main id="main" class="p-6 overflow-y-scroll h-[90vh] space-y-2">
            <h2
                class="text-2xl font-semibold m-4 w-fit bg-gradient-to-r from-primary via-purple-600 to-blue-800 bg-clip-text text-transparent">
                Project
            </h2>
            <hr>
            <div id="content" class="w-full h-[90%] bg-white shadow-md rounded-lg overflow-auto">
                <div id="section-content" class="p-8 w-full min-h-full overflow-y-auto">
                    <div id="section-project-details" class="section grid md:grid-cols-2 h-full relative">
                        <div class="text-sm">
                            <h2 class="text-lg font-semibold"></h2>
                            <div onclick="openPopup()" class="cursor-pointer w-fit" id="status">Pending</div>
                            <div class="absolute inset-x-1/3" onclick="openEdit('project')"><i
                                    class="fa-regular fa-pen-to-square cursor-pointer"></i></div>
                            <p class="p-3">Description</p>
                            <h5 class="px-3 font-medium text-md">Project Documents:</h5>
                            <div id="project-files">

                            </div>
                            <div id="project-teams" class="p-3 relative w-full">

                            </div>
                        </div>

                        <div class="text-sm h-fit space-y-4">
                            <h5 class="font-medium my-2">Due Date: <span class="text-textPrimary"
                                    id="due_date">3/7/2026</span></h5>
                            <h5 class="font-medium my-2">Worked Hours: <span class="text-textPrimary"
                                    id="worked_hour">3</span></h5>
                            <div class="font-medium my-2 flex w-fit gap-4">Progress:
                                <div class="relative w-12 h-12 -mt-2">
                                    <div class="absolute inset-0 rounded-full bg-gray-200"></div>

                                    <div id="progress-left" class="absolute inset-0 rounded-full overflow-hidden">
                                        <div class="absolute inset-0 origin-center-left transform"
                                            style="clip: rect(0, 999px, 999px, 24px);"></div>
                                    </div>

                                    <div id="progress-right" class="absolute inset-0 rounded-full overflow-hidden">
                                        <div class="absolute inset-0 origin-center-right transform"
                                            style="clip: rect(0, 24px, 999px, 0);"></div>
                                    </div>

                                    <div
                                        class="absolute inset-2 bg-white rounded-full flex items-center justify-center text-center text-gray-800">
                                        <span id="progress-text" class="text-center w-full">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="font-semibold relative">Tasks
                                <div class="absolute top-0 left-28" onclick="openEdit('tasks')"><i class="fa-regular fa-plus cursor-pointer"></i></div>
                            </div>
                            <div class="max-h-64 overflow-y-auto flex flex-col gap-2" id="project_tasks">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="request-list" class="h-[90%]">
                <div class="w-full min-h-full bg-white shadow-md rounded-lg overflow-hidden flex">
                    <!-- Sidebar -->
                    <div class="max-w-1/4 min-w-fit min-h-full bg-gray-50 p-6 border-r flex flex-col justify-between">
                        <ul class="space-y-4 text-sm text-gray-700">
                            <li class="menu-item cursor-pointer font-bold text-blue-600" data-section="project">Project
                            </li>
                            <li class="menu-item cursor-pointer" data-section="add-new"><i class="fa-solid fa-plus"></i>
                                Add Project</li>
                        </ul>
                        <div class="flex gap-2 items-center bg-tranparent p-3 text-base pageBtn" id="button-project">
                            <button id="project-previous"><i class="fa-solid fa-circle-chevron-left"></i></button>
                            <span id="project-countMessage">5 of 10</span>
                            <button id="project-next"><i class="fa-solid fa-circle-chevron-right"></i></button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div id="section-content" class="w-full min-h-full">
                        <div id="section-project" class="section">

                        </div>
                        <div id="section-add-new" class="section">

                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-area" class="fixed inset-0 flex-1 justify-items-center mt-24 hidden h-[90%]">
        <div class="bg-white w-1/2 max-h-full shadow-md rounded-lg overflow-y-auto relative">
            <i class="absolute top-4 right-4 text-2xl fa-solid fa-xmark icon-remove cursor-pointer"
                onclick="closeEdit()"></i>
            <div id="load-area"></div>
        </div>
    </div>

    <div id="Popup-menu" class="fixed inset-0 w-full h-full flex-1 justify-items-center hidden">
        <div class="mt-28 min-w-96 min-h-56 bg-white rounded-lg shadow-md py-8 px-6 space-y-5">
            <h5 class="font-medium text-lg">Project Status</h5>
            <div id="project-status" class="w-full"></div>

            <div>
                <button onclick="updateStatus()"
                    class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                                hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500 mr-2">Change</button>
                <button onclick="closePopup()"
                    class="bg-gray-50 hover:bg-gray-300 font-semibold text-xs py-2 px-8 shadow-sm shadow-third rounded-lg mr-2">Close</button>
            </div>
        </div>
    </div>
    <script>
        let SelectedID
        let access
        let List = $("#request-list")
        let Content = $("#content")
        let ProjectDetail
        let SelectedTaskID,ProjectTaskDetail = null
        $(document).ready(function () {
            SelectedID = urlParams.get("project_id")
            access = JSON.parse($.cookie("my_access"))
            $("#main .menu-item").click(function () {
                $("#main .menu-item").removeClass("font-bold text-blue-600")
                $(this).addClass("font-bold text-blue-600")

                let section = $(this).attr("data-section")
                $("#main .section").hide()
                $(`#main #section-${section}`).show()
                $("#main .pageBtn").hide()
                $(`#main #button-${section}`).show()

            });

            $(`#main #section-content #section-project`).load("./componnet/project/project_list.html")
            if("project" in access){
                $(`#main #section-content #section-add-new`).load("./componnet/project/new_project.html")
            }else{
                $(`#main #section-content #section-add-new`).hide()
                $("#main li[data-section=add-new]").hide()
                $("#main #content div[onclick] i.fa-pen-to-square").hide()
                $("#main #content div[onclick] i.fa-plus").hide()
            }
            $("#main .section").hide()
            $(`#main #section-project`).show()
            $("#main .pageBtn").hide()
            $(`#main #button-project`).show()

            if (SelectedID) {
                Content.show()
                List.hide()
                ProjectDetails(SelectedID)
                $("#main .section").hide()
                $(`#main #section-project-details`).show()
            } else {
                List.show()
                Content.hide()
            }


        });

        function openEdit(tag) {
            if("project" in access){
                $("#edit-area").show()
                if (tag == "project")
                    $("#load-area").load("./componnet/project/new_project.html")
                else if (tag == "team")
                    $("#load-area").load("./componnet/project/project_team.html")
                else if (tag == "tasks"){
                    
                    $("#load-area").load("./componnet/project/new_project_task.html")
                    setTimeout(()=>{
                        $("#load-area form#new-task-form select#project_id").val(SelectedID)
                        $("#load-area form#new-task-form select#project_id").prop("disabled",true)
                    },1000)
                }

                $(`#main #section-content #section-add-new`).empty()
            }
        }
        function closeEdit() {
            $("#edit-area").hide()
            $("#load-area").empty()
        }
        function ProjectDetails(ID) {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/project/${ID}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            ProjectDetail = data.project
                            ProjectDataExtraction()
                        } else {
                            showAlertMessage("error", "Project", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }
        }

        function ProjectDataExtraction() {
            Content.find("#status").html(StatusColourCode(ProjectDetail.status))
            Content.find("p").html(`<h5>Description</h5> ${ProjectDetail.description || "--"}`)
            Content.find("h2").text(`${ProjectDetail.name || "--"}`)
            Content.find("#project-files").html(ProjectFiles(ProjectDetail.file))
            Content.find("#project-teams").html(ProjectTeam(ProjectDetail.team))
            Content.find("#due_date").text(ProjectDetail.due_date ? new Date(ProjectDetail.due_date).toLocaleDateString() : "not declared")
            Content.find("#worked_hour").text(ProjectDetail.worked_hour)
            updateProgressBar(ProjectDetail.progress)
            Content.find("#project_tasks").html(ProjectTasks(ProjectDetail.tasks))
        }

        function ProjectFiles(data) {
            let result = ''
            data.forEach(element => {
                result += `
                    <div class="p-3 flex w-1/2 justify-around">
                        <div>${capitalizeFirstLetter(element.name)}</div>
                        <div>${new Date(element.updated_at).toLocaleDateString()}</div>
                        <div onclick="FilePreviewURL('${element.file_path}')" class="text-sm text-blue-400 cursor-pointer">Preview</div>
                    </div>`
            });

            return result
        }

        function ProjectTeam(data) {
            let result = ""
            // console.log(data)
            if (data?.id) {
                result = `<h4 class="font-semibold my-2">Team name: <span class="text-textPrimary">${capitalizeFirstLetter(data.name)}</span></h4>
                        <h5 class="font-medium my-2">Members: <span class="text-textPrimary">${data.member?.length}</span></h5>
                        ${("project" in access) ? `
                        <div class="absolute top-10 right-1/3" onclick="openEdit('team')"><i class="fa-regular fa-pen-to-square cursor-pointer"></i></div>
                        `:""}
                        <div class="flex -space-x-4 rtl:space-x-reverse w-fit max-h-40 overflow-y-auto my-2 cursor-pointer" 
                            id="team-members" onclick="teamDetails('more')">
                            
                        </div>
                        <div id="team-member-details" class="relative hidden max-h-64 overflow-auto">
                            <table class="w-full border-collapse text-xs mt-2">
                                <thead>
                                    <tr class="bg-gray-50 text-gray-700 text-left">
                                        <th class="p-2 border-b"></th>
                                        <th class="p-2 border-b">Employee ID</th>
                                        <th class="p-2 border-b">Full Name</th>
                                        <th class="p-2 border-b">Email</th>
                                        <th class="p-2 border-b">Worked Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                </tbody>
                            </table>
                            <div class="absolute bottom-0 right-4 text-lg cursor-pointer" onclick="teamDetails('less')">
                                <i class="fa-solid fa-circle-chevron-up"></i>
                            </div>
                        </div>
                        `
                setTimeout(() => MemberExtract(data.member), 200)
            } else {
                result = `
                    <h4 class="font-semibold my-2">Team</h4>
                    <button onclick="openEdit('team')" class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                            hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">
                            Create One
                    </button>
                    `
            }

            return result
        }

        function teamDetails(action) {
            if (action == "more") {
                Content.find("#project-teams #team-member-details").show()
                Content.find("#project-teams #team-members").hide()
            } else if (action == "less") {
                Content.find("#project-teams #team-member-details").hide()
                Content.find("#project-teams #team-members").show()
            }
        }

        async function MemberExtract(data) {
            // console.log(data)
            let ln = data?.length
            let mm = Content.find("#project-teams #team-members")
            let md = Content.find("#project-teams #team-member-details tbody")
            mm.empty()
            for (let i = 0; i < ln; i++) {
                let element = data[i]
                // console.log(element, i)
                    let url = `https://ui-avatars.com/api/?name=${element.user?.first_name || "aes000"}+${element.user?.last_name}`
                    if (element.user?.file_path)
                        url = await FilePreviewURL(element.user.file_path, false)
                    if (i <= 2) {
                    mm.append(`<img class="w-10 h-10 border-2 border-white rounded-full dark:border-gray-800"
                                    src="${url}" alt="">`)
                    }
                    md.append(`
                        <tr id="${element?.user_id}">
                            <td class="p-2 w-fit h-fit"><img class="w-10 h-10 border-2 border-white rounded-full dark:border-gray-800"
                                    src="${url}" alt=""></td>
                            <td class="p-2">${element?.user?.user_name}</td>
                            <td class="p-2">${element?.user?.first_name} ${element?.user?.last_name}</td>
                            <td class="p-2">${element?.user?.email}</td>
                            <td class="p-2" id="hour">0</td>
                        </tr>
                    `)
            }
            ln > 3 ? mm.append(`<a class="flex items-center justify-center w-10 h-10 text-xs font-medium text-white bg-gray-700 border-2 border-white rounded-full hover:bg-gray-600 dark:border-gray-800"
                                href="#">+${ln - 3}</a>`) : ""
        }

        function ProjectTasks(data) {
            let result = ""
            data.forEach(element => {
                result += `
                    <div class="border p-3 rounded-lg relative text-xs">
                        <h4 class="font-semibold">${capitalizeFirstLetter(element.name)}</h4>
                        <h5 class="my-2">Worked Hours: <span class="text-textPrimary"
                                id="worked_hour">${element.worked_hour}</span></h5>
                        <div class="absolute right-4 top-4">
                            ${ProjectStatusColourCode(element.state)}
                            <a href="project-task.html?task_id=${element.id}" class="px-2"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full dark:bg-gray-700">
                            <div class="bg-blue-600 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full"
                                style="width: ${element.progress}%"> ${element.progress}%</div>
                        </div>
                    </div>
                `
                setTimeout(() => TimeSheetWorkedHour(element.time_sheet), 1000)
            })
            return result
        }

        function TimeSheetWorkedHour(sheet) {
            sheet.forEach((sh, index) => {
                let data = Content.find(`#project-teams #team-member-details tbody tr#${sh.user_id} #hour`)
                let hr = data.text().trim()
                let tl = sh.total_hours + (parseInt(hr) || 0)
                data.text(tl)
            })
        }

        function updateProgressBar(value) {
            const clampedValue = Math.max(0, Math.min(100, value));
            const LeftInner = Content.find('#progress-left div');
            const RightInner = Content.find('#progress-right div');
            const progressText = document.getElementById('progress-text');
            if (clampedValue <= 50) {
                // First half (0-50%) - only right half rotates
                const rotation = (clampedValue / 50) * 180;
                RightInner.addClass(`rotate-[0deg] bg-gray-200`);
                LeftInner.addClass(`rotate-[${180 + rotation}deg] bg-blue-500`);
            } else {
                // Second half (51-100%) - right half completes, left half rotates
                RightInner.addClass(`rotate-[180deg] bg-blue-500`);
                const rotation = ((clampedValue - 50) / 50) * 180;
                LeftInner.addClass(`rotate-[${rotation}deg] bg-blue-500`);
            }

            progressText.textContent = `${Math.floor(clampedValue)}%`;
        }

        function openPopup() {
            if("project" in access){
                $("#Popup-menu").show()
                $("#Popup-menu #project-status").html(SelectionTag("status", "status", "Status", statusNames[ProjectDetail?.status]
                    , true, Object.values(statusNames).slice(1, 3)))
            }
        }
        function closePopup() {
            $("#Popup-menu").hide()
        }

        function updateStatus() {
            let statusVal = $("#Popup-menu #project-status #status").val()
            if (statusVal == "--") {
                showAlertMessage("error", "Project Task", "Select project status")
            } else {
                let status = Object.keys(statusNames).find(k => statusNames[k] === statusVal)
                if (SelectedID) {
                    try {
                        ProgressLoading(true)
                        fetch(`${DomainURL}/project/${SelectedID}`, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${access_token}`
                            },
                            body: JSON.stringify({
                                "status": parseInt(status)
                            })
                        })
                            .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                            .then(data => {
                                if (data.status) {
                                    showAlertMessage("success", "Project", "Project status updated.")
                                    closePopup()
                                    setTimeout(() => { window.location.reload() }, 800)
                                } else {
                                    showAlertMessage("error", "Project", data.message)
                                }
                                ProgressLoading(false)
                            })
                    } catch (error) {
                        ProgressLoading(false)
                        showAlertMessage("warning", "API error", error)
                    }
                } else
                    showAlertMessage("error", "Project", "Error to find project id.")
            }
        }

    </script>


</body>

</html>