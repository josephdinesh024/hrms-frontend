<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Appraisal</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <!-- Custom Tailwind Theme -->
    <script src="./static/js/theme.js"></script>
    <script src="./static/js/profileAction.js"></script>
    <script src="./static/js/confic.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
    <!-- FontAwesome for Icons -->
    <script src="https://kit.fontawesome.com/5d4c9f5ac8.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
</head>

<body class="flex bg-background w-screen">
    <div id="sidebar"></div>

    <div class="flex-1 w-full">
        <!-- Header -->
        <div id="header"></div>

        <main id="main" class="p-6 overflow-y-scroll h-[90vh] space-y-2">
            <h2
                class="text-2xl font-semibold m-4 w-fit bg-gradient-to-r from-primary via-purple-600 to-blue-800 bg-clip-text text-transparent">
                Appraisal
            </h2>
            <hr>
            <div id="request-list" class="w-full h-[90%] bg-white shadow-md rounded-lg overflow-hidden flex">

            </div>
            <div id="content" class="hidden h-[90%]">
                <div class="w-full min-h-full bg-white shadow-md rounded-lg overflow-hidden flex">
                    <!-- Sidebar -->
                    <div class="max-w-1/4 min-w-fit bg-gray-50 p-6 border-r">
                        <h3 class="font-semibold bg-gradient-to-r from-primary via-purple-600 to-blue-800 bg-clip-text text-transparent p-3"
                            id="employeeFullName">
                            aes000
                        </h3>
                        <div id="profile_image" class="flex-1 justify-items-center mb-2">
                            <img src="https://ui-avatars.com/api/?name=aes000" alt="Avatar"
                                class="w-20 h-20 rounded-full shadow">
                        </div>
                        <div id="employeeStatus" class="text-center w-full mb-8 cursor-pointer menu-item"
                            data-section="status">

                        </div>
                        <ul class="space-y-4 text-sm text-gray-700">
                            <li class="menu-item cursor-pointer font-bold text-blue-600" data-section="appraisal_request">
                                Appraisal Request
                            </li>
                            <li class="menu-item cursor-pointer" data-section="profile">Profile</li>
                            <!-- <li class="menu-item cursor-pointer" data-section="leave">Leave</li>
                            <li class="menu-item cursor-pointer" data-section="entry">New entry</li> -->
                        </ul>
                    </div>

                    <!-- Content -->
                    <div id="section-content" class="p-8 w-full min-h-full overflow-y-auto">
                        <div id="section-appraisal_request" class="section h-full">
                            <h2 class="text-lg font-semibold">Request Details</h2>
                            <div id="status">Pending</div>
                            <div class="grid md:grid-cols-2 mt-6">
                                <div class="space-y-6" id="employee-feedback">
                                    
                                </div>

                                <div class="text-sm h-fit space-y-2" id="reportee-feedback">
                                    <h3 class="text-base font-medium underline underline-offset-4">Reportee Feedbak </h3>
                                    <div class="w-full relative mt-6 floating-label">
                                        <input type="text" id="comment" name="comment" required
                                            class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                                        <label for="comment"
                                            class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                                            Comment<span class="text-red-600">*</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-end justify-end" id="actionBtn">
                                <div></div>
                                <div>
                                    <button data-status="3" class="border p-3 text-sm border-green-400 rounded-lg StatusBtn">Approved</button>
                                    <button data-status="4" class="border p-3 text-sm border-red-400 rounded-lg StatusBtn">Rejected</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="section-profile" class="section">
                            <h2 class="text-lg font-semibold mb-6">Personal Details</h2>
                            <div class="grid grid-cols-2 gap-6">
                                <div class="col-span-2">
                                    <h4>Full Name</h4>
                                    <div class="flex justify-between w-3/4 gap-4 mt-3">
                                        <span id="first_name" class="text-textPrimary border-b-2 w-full">First
                                            Name</span>
                                        <span id="last_name" class="text-textPrimary border-b-2 w-full">Last Name</span>
                                    </div>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Employee ID</h4>
                                    <span id="user_name" class="text-textPrimary">aes000</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Email</h4>
                                    <span id="email" class="text-textPrimary">aes000@gmail.com</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Phone</h4>
                                    <span id="phone" class="text-textPrimary">996******4</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Date of Birth</h4>
                                    <span id="dob" class="text-textPrimary">dd/mm/yyyy</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Gender</h4>
                                    <span id="gender" class="text-textPrimary">gender</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Address</h4>
                                    <span id="address" class="text-textPrimary">address</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">City</h4>
                                    <span id="city" class="text-textPrimary">city</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">State</h4>
                                    <span id="state" class="text-textPrimary">state</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">Country</h4>
                                    <span id="country" class="text-textPrimary">country</span>
                                </div>
                                <div class="border-b-2 w-3/4">
                                    <h4 class="mb-3">PinCode</h4>
                                    <span id="pincode" class="text-textPrimary">pincode</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        let SelectedID
        let List = $("#request-list")
        let Content = $("#content")
        let RequestDetail
        let SelectedUser
        $(document).ready(function () {
            SelectedID = urlParams.get("request_id")
            $("#main .menu-item").click(function () {
                $("#main .menu-item").removeClass("font-bold text-blue-600")
                $(this).addClass("font-bold text-blue-600")

                let section = $(this).attr("data-section")
                $("#main .section").hide()
                $(`#main #section-${section}`).show()

            });

            if (SelectedID) {
                List.hide()
                Content.show()
                $("#main .section").hide()
                $(`#main #section-appraisal_request`).show()
                RequestDetails(SelectedID)
            } else {
                Content.hide()
                List.show()
                $("#request-list").load("./componnet/appraisal/appraisal.html")
            }

            $(document).on("click","#main #content #section-content #section-appraisal_request button.StatusBtn",function(){
                let status = $(this).data("status")
                let comment = $("#main #content #section-content #section-appraisal_request input#comment").val()
                if(comment == ""){
                    showAlertMessage("warning","Appraisal Request", "Fill comment to continue")
                    $("#main #content #section-content #section-appraisal_request input#comment").focus()
                }else{
                    try {
ProgressLoading(true)
                    fetch(`${DomainURL}/manage/request/${SelectedID}`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        method: "PUT",
                        body: JSON.stringify({
                            "description": comment,
                            "status": status
                        })
                    })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning","API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            showAlertMessage("success","Appraisal Request",data.message)
                            setTimeout(()=>{window.location.href = "appraisal.html"},1000)
                        } else {
                            showAlertMessage("error","Appraisal Request",data.message)
                        }
                    });
                } catch (error) {
ProgressLoading(false)
                    showAlertMessage("warning","API error", error)
                }
                }
            })
        });

        function RequestDetails(ID) {
            try {
ProgressLoading(true)
                fetch(`${DomainURL}/manage/request/${ID}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        console.log(data)
                        if (data.status) {
                            RequestDetail = data.request
                            SelectedUser = RequestDetail.module.user
                            SelectedUser.profile["email"] = SelectedUser.email
                            SelectedUser.profile["user_name"] = SelectedUser.user_name
                            profileDataExtraction(SelectedUser.profile,"section-profile")
                            $("#main #content #section-content #section-appraisal_request #status").html(StatusColourCode(RequestDetail.status))
                            dataExtraction()
                        } else {
                            showAlertMessage("error", "Time sheet", data.message)
                        }
                    })
            } catch (error) {
ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }
        }

        function dataExtraction(){
            let section = $("#main #content #section-content #section-appraisal_request")
            let module = RequestDetail.module
            section.find("#employee-feedback").empty()
            section.find("#employee-feedback").append(`
            <h3 class="text-base font-medium underline underline-offset-4">Employee Feedbak </h3>
            `)
            module.answer.forEach((element,i) => {
                section.find("#employee-feedback").append(`
                    <div class=" questions" id="${element["index"]}">
                        <h3 class="text-textPrimary">${i+1}) ${element.question}</h3>
                        <textarea rows="8" class="w-[90%] bg-transparent border-b-2 focus:outline-none text-sm mt-6">
                            ${element.answer}
                        </textarea>
                    </div>
                `)
            })
            section.find("#employee-feedback").append(`
                <div class="questions" >
                    <h3 class="text-textPrimary">Final Feedback</h3>
                    <p class="w-full border-b-2 text-sm mt-6">
                        ${module.description || "--"}
                    </p>
                </div>
            `)
            $("#main #content #section-content #section-appraisal_request input#comment").val(RequestDetail.description)
            if(RequestDetail.status)
                $("#main #content #section-content #section-appraisal_request #actionBtn").hide()
            else
                $("#main #content #section-content #section-appraisal_request #actionBtn").show()
        }


    </script>


</body>

</html>