<div id="policyCardList" class="w-full mb-4 cardLists">
    <table class="w-full border-collapse text-xs">
        <thead>
            <tr class="bg-gray-100 text-gray-700 text-left">
                <th class="p-4 border-b">Name</th>
                <th class="p-4 border-b">Max leaves</th>
                <th class="p-4 border-b">Leave type</th>
                <th class="p-4 border-b">Tenure Required (month)</th>
                <th class="p-4 border-b">Approval</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>

<div id="policyEditPanel" class="p-5 hidden policy-details">
    <form id="policyForm">
        <div class="grid md:grid-cols-2">
            <div class="relative mt-6 floating-label">
                <input type="text" id="name" name="name" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="name"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Name
                </label>
            </div>
            <div class="relative mt-6 w-64 floating-label">
                <label for="leave_type" class="w-full text-sm text-blue-500">
                    Leave Type
                </label>
                <select
                    class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="leave_type" name="leave_type">
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>
        </div>

        <div class="grid md:grid-cols-2">
            <div class="relative mt-6 floating-label">
                <input type="number" id="max_leaves" name="max_leaves" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="max_leaves"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Max leave
                </label>
            </div>
            <div class="relative mt-6 floating-label">
                <input type="number" id="tenure_required" name="tenure_required" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="tenure_required"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Tenure Months
                </label>
            </div>
        </div>

        <div class="grid md:grid-cols-2">
            <div class="relative mt-6 floating-label">
                <input type="text" id="description" name="description"
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="description"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Description
                </label>
            </div>
            <div class="relative mt-6 w-64 floating-label">
                <label for="status" class="w-full text-sm text-blue-500">
                    Policy Status
                </label>
                <select
                    class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="policyStatus" name="active">
                    <option value="true">Active</option>
                    <option value="false">Deactive</option>
                </select>
            </div>
        </div>

        <div class="my-4">
            <button type="submit"
                class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                            hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">Submit</button>
        </div>
    </form>
</div>
<script>
    $(function () {
        let page = 1
        let paseSize = PAGESIZE
        let TotalCount = 0
        var access_token = $.cookie("access_token")
        let policy = []
        let policyStatus = ""
        let policyID = 0
        function initFetch() {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/timesheet/policy?active=${policyStatus}`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            $("#policyCardList tbody").empty()
                            policy = data.policy
                            policy.forEach((element, index) => {
                                $("#policyCardList tbody").append(`
                        <tr id="${index}" data-id="${element.id}" class="border-b hover:bg-gray-50 transition selectedList">
                            <td class="p-4">${capitalizeFirstLetter(element.name)}</td>
                            <td class="p-4">${element.max_leaves}</td>
                            <td class="p-4">${capitalizeFirstLetter(element.leave_type)}</td>
                            <td class="p-4">${element.tenure_required}</td>
                            <td class="p-4">${!element.active ? `<span class="px-3 py-1 text-xs font-bold text-white bg-red-600 rounded-md"> Deactive </span>` :
                                        `<span class="px-3 py-1 text-xs font-bold text-green-700 bg-green-100 rounded-md"> Active </span>`
                                    }</td>
                        </tr>
                    `)

                            });

                            TotalCount = data.total_count
                            var total = (page - 1) * paseSize
                            $("#policy-countMessage").text(`${total + data.policy.length} of ${TotalCount}`)
                        }
                        ProgressLoading(false)
                    });

            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

        }

        initFetch()


        $(document).on("click", "button#policy-previous", function () {
            if (page != 1) {
                page -= 1
                initFetch()
            }
        })

        $(document).on("click", "button#policy-next", function () {
            let check = TotalCount - (paseSize * page)
            if (check > 0) {
                page += 1
                initFetch()
            }
        })


        $(document).on("click", "#AddNewPolicy", function () {
            policyID = 0
            $("#policyEditPanel").show()
            $("#policyEditPanel form")[0].reset()
            $("#policyCardList").hide()
            $("#policyEditPanel #policyStatus").parent().hide()
        });

        $(document).on("click", "#policyCardList tbody .selectedList", function () {
            window.location.href = "?policy_id=" + $(this).data("id")
        })

        $(document).ready(function () {
            policyID = SelectedPolicyID || 0
            if (SelectedPolicyID) {
                SelectedPolicy(SelectedPolicyID)
                $(".policy-details").show()
                $(".cardLists").hide()
            }
        })

        function SelectedPolicy(ID) {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/timesheet/policy/${ID}`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        console.log(data)
                        if (data.status) {
                            pol = data.policy
                            Object.keys(pol).forEach(key => {
                                $(`#policyEditPanel form [name=${key}]`).val(pol[key])
                            });
                            $("#policyEditPanel #policyStatus").parent().show()
                            $("#policyEditPanel #policyStatus").val(pol["active"] ? "true" : "false")
                        } else {
                            showAlertMessage("warning", "Leave Policy", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

        };

        $(document).off("submit", "#policyEditPanel #policyForm");
        $(document).on("submit", "#policyEditPanel #policyForm", function (e) {
            e.preventDefault()
            let formData = new FormData(this);
            let data = {}
            let flag = true
            formData.forEach((v, k) => {
                if (k == "active") {
                    data[k] = v == "true" ? true : false
                }
                else if (["max_leaves", "tenure_required"].includes(k)) {
                    data[k] = parseInt(v)
                } else if (k == "leave_type" && v == "--") {
                    flag = false
                    showAlertMessage("warning", "Leave Policy", "Leave type should not be empty.")
                }
                else
                    data[k] = v

            })
            // console.log(data) 
            if (flag)
                try {
                    ProgressLoading(true)
                    fetch(`${DomainURL}/timesheet/policy${policyID ? "/" + policyID : ''}`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        method: policyID ? "PUT" : "POST",
                        body: JSON.stringify(data)
                    })
                        .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                        .then(data => {
                            // console.log(data)
                            if (data.status) {
                                showAlertMessage("success", "Time policy", policyID ? "Updated policy " : "Added new time policy")
                                initFetch()
                                $("#policyEditPanel").hide()
                                $("#policyCardList").show()
                            } else {
                                showAlertMessage("error", "Time policy", data.message)
                            }
                            ProgressLoading(false)
                        });
                } catch (error) {
                    ProgressLoading(false)
                    showAlertMessage("warning", "API error", error)
                }

        })


        let formDatas = `<form id="policyForm" class="w-5/6 grid md:grid-cols-2 gap-5">
            ${floatingInputTag("text", "name", "name", "Policy Name", "")}
            ${SelectionTag("leave_type", "leave_type", "Policy Type", "", true, options = ["paid", "unpaid"])}
            ${floatingInputTag("number", "max_leaves", "max_leaves", "Max Leave", "")}
            ${floatingInputTag("number", "tenure_required", "tenure_required", "Tenure Months", "")}
            ${floatingInputTag("text", "description", "description", "Description", "", false)}
            `


    })
</script>
<!-- 
<div class="text-xs m-3 font-medium space-y-3">
                <label for="policyName">Policy name</label>
                <input type="search" id="policyName" name="name" required class="border p-2 w-full rounded-lg" placeholder="name" />
            </div>
            <div class="text-xs m-3 font-medium space-y-3">
                <label for="policyType">Policy type</label>
                <select id="policyType" name="leave_type" class="w-full p-2 border rounded-lg">
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>
            <div class="text-xs m-3 font-medium space-y-3">
                <label for="maxLeave">Max leave</label>
                <input type="number" id="maxLeave" name="max_leaves" required class="w-full p-2 border rounded-lg" placeholder="leaves"/>
            </div>
            <div class="text-xs m-3 font-medium space-y-3">
                <label for="tenureMonth">Tenure months</label>
                <input type="number" id="tenureMonth" name="tenure_required" class="w-full p-2 border rounded-lg" placeholder="no of month"/>
            </div>
            <div class="text-xs m-3 font-medium space-y-3">
                <label for="policyReason">Time off Reason</label>
                <input type="text" id="policyReason" name="description" class="p-2 border w-full min-h-16 text-start" placeholder="reason" />
            </div> -->
<div></div>