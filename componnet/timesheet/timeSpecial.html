<div id="specialPolicyCardList" class="mb-4 cardLists">
    <table class="w-full border-collapse text-xs">
        <thead>
            <tr class="bg-gray-100 text-gray-700 text-left">
                <th class="p-4 border-b">Role</th>
                <th class="p-4 border-b">Name</th>
                <th class="p-4 border-b">Max leaves</th>
                <th class="p-4 border-b">Tenure Required (month)</th>
                <th class="p-4 border-b">Approval</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>
<div id="specialPolicyEditPanel" class="hidden p-5 policy-details">
    <form id="specialPolicyForm">
        <div class="grid md:grid-cols-2">
            <div class="relative mt-6 w-64 floating-label">
                <label for="role_id" class="w-full text-sm text-blue-500">
                    Role
                </label>
                <select
                    class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="role_id" name="role_id">
                    <option value="--">--</option>
                </select>
            </div>

            <div class="relative mt-6 floating-label">
                <input type="text" id="name" name="name" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="name"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Name
                </label>
            </div>
            <div class="relative mt-6 w-64 floating-label">
                <label for="leave_type" class="w-full text-sm text-blue-500">
                    Leave Type
                </label>
                <select
                    class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="leave_type" name="leave_type">
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>

            <div class="relative mt-6 floating-label">
                <input type="number" id="max_leaves" name="max_leaves" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="max_leaves"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Max leave
                </label>
            </div>
            <div class="relative mt-6 floating-label">
                <input type="number" id="tenure_required" name="tenure_required" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="tenure_required"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Tenure Months
                </label>
            </div>

            <div class="relative mt-6 floating-label">
                <input type="text" id="description" name="description"
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="description"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Description
                </label>
            </div>
            <div class="relative mt-6 w-64 floating-label">
                <label for="status" class="w-full text-sm text-blue-500">
                    Policy Status
                </label>
                <select
                    class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="policyStatus" name="active">
                    <option value="true">Active</option>
                    <option value="false">Deactive</option>
                </select>
            </div>

            <div class="my-4 col-span-2">
                <button type="submit"
                    class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                                hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">Submit</button>
            </div>
        </div>
    </form>
</div>

<script>
    $(function () {
        let page = 1
        let paseSize = PAGESIZE
        let TotalCount = 0
        let policy = []
        let policyStatus = ""
        let roleList = []
        let specialID
        function initFetch() {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/role?page_size=50`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        if (data.status) {
                            // console.log(data)
                            data.roles.forEach(element => {
                                // if (element.active)
                                $("#specialPolicyEditPanel form [name=role_id]").append(`<option value="${element.id}">${capitalizeFirstLetter(element.name)}</option>`)
                                roleList.push(`<option value="${element.id}">${capitalizeFirstLetter(element.name)}</option>`)
                            })
                        }
                        ProgressLoading(false)
                    });
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/timesheet/special?active=${policyStatus}`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            $("#specialPolicyCardList tbody").empty()
                            policy = data.special_policy
                            policy.forEach((element, index) => {
                                $("#specialPolicyCardList tbody").append(`
                        <tr id="${index}" data-id="${element.id}" class="border-b hover:bg-gray-50 transition selectedList">
                            <td class="p-4">${capitalizeFirstLetter(element.role.name)}</td>
                            <td class="p-4">${capitalizeFirstLetter(element.name)}</td>
                            <td class="p-4">${element.max_leaves}</td>
                            <td class="p-4">${element.tenure_required}</td>
                            <td class="p-4">${!element.active ? `<span class="px-3 py-1 text-xs font-bold text-white bg-red-600 rounded-md"> Deactive </span>` :
                                        `<span class="px-3 py-1 text-xs font-bold text-green-700 bg-green-100 rounded-md"> Active </span>`
                                    }</td>
                        </tr>
                    `)

                            });

                            TotalCount = data.total_count
                            var total = (page - 1) * paseSize
                            $("#special-countMessage").text(`${total + data.special_policy.length} of ${TotalCount}`)
                        }
                        ProgressLoading(false)
                    });

            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

        }

        initFetch()

        $(document).on("click", "button#special-previous", function () {
            if (page != 1) {
                page -= 1
                initFetch()
            }
        })

        $(document).on("click", "button#special-next", function () {
            let check = TotalCount - (paseSize * page)
            if (check > 0) {
                page += 1
                initFetch()
            }
        })


        $(document).on("click", "#AddNewSpecialPolicy", function () {
            specialID = 0
            $("#specialPolicyEditPanel").show()
            $("#specialPolicyEditPanel form")[0].reset()
            $("#specialPolicyCardList").hide()
            $("#specialPolicyEditPanel #policyStatus").parent().hide()

        });

        $(document).on("click", "#specialPolicyCardList tbody .selectedList", function () {
            window.location.href = "?special_id=" + $(this).data("id")
        })

        $(document).ready(function () {
            specialID = SelectedSpecialID || 0
            if (SelectedSpecialID) {
                SelectedSpecialPolicy(SelectedSpecialID)
                $(".policy-details").show()
                $(".cardLists").hide()
            }
        })

        function SelectedSpecialPolicy(ID) {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/timesheet/special/${ID}`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        console.log(data)
                        if (data.status) {
                            pol = data.special_policy

                            Object.keys(pol).forEach(key => {
                                $(`#specialPolicyEditPanel form [name=${key}]`).val(pol[key])
                            });
                            $("#specialPolicyEditPanel #policyStatus").parent().show()
                            $("#specialPolicyEditPanel #policyStatus").val(pol["active"] ? "true" : "false")
                        } else {
                            showAlertMessage("warning", "Leave Policy", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

        };

        $(document).off("submit", "#specialPolicyEditPanel #specialPolicyForm");
        $(document).on("submit", "#specialPolicyEditPanel #specialPolicyForm", function (e) {
            e.preventDefault()
            let formData = new FormData(this);
            let data = {}
            let flag = true
            formData.forEach((v, k) => {
                if (k == "active") {
                    data[k] = v == "true" ? true : false
                } else if (["leave_type", "role_id"].includes(k) && v == "--") {
                    flag = false
                    showAlertMessage("warning", "Leave Policy", "Leave type or Role should not be empty.")
                }
                else if (["max_leaves", "tenure_required", "role_id"].includes(k)) {
                    data[k] = parseInt(v)
                }
                else
                    data[k] = v
            })
            // console.log(data) 
            if (flag)
                try {
                    ProgressLoading(true)
                    fetch(`${DomainURL}/timesheet/special${specialID ? "/" + specialID : ''}`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        method: specialID ? "PUT" : "POST",
                        body: JSON.stringify(data)
                    })
                        .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                        .then(data => {
                            console.log(data)
                            if (data.status) {
                                showAlertMessage("success", "Time policy", specialID ? "Updated special policy " : "Added new special policy")
                                initFetch()
                                $("#specialPolicyEditPanel").hide()
                                $("#specialPolicyCardList").show()
                            } else {
                                showAlertMessage("error", "Time policy", data.message)
                            }
                            ProgressLoading(false)
                        });
                } catch (error) {
                    ProgressLoading(false)
                    showAlertMessage("warning", "API error", error)
                }

        })


        let formDatas = `<form id="specialPolicyForm" class="w-5/6 grid md:grid-cols-2 gap-5">
            <div class="mt-5">
                <label class="w-full text-sm text-blue-500">Role</label>
                <select class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                    id="role_id" name="role_id"
                    "required" >
                    <option>--</option>
                    
                </select>
            </div>
            ${floatingInputTag("text", "name", "name", "Policy Name", "")}
            ${SelectionTag("leave_type", "leave_type", "Policy Type", "", true, options = ["paid", "unpaid"])}
            ${floatingInputTag("number", "max_leaves", "max_leaves", "Max Leave", "")}
            ${floatingInputTag("number", "tenure_required", "tenure_required", "Tenure Months", "")}
            ${floatingInputTag("text", "description", "description", "Description", "", false)}
            `

    })
</script>