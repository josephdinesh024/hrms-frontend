<div class="mb-4">
    <button data-method="time_sheet" class="actionBtn py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs
        hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">Add
        time entery</button>
    <button data-method="leave_request" class="actionBtn py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs
        hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">
        Leave request
    </button>
</div>
<hr>
<div class="flex w-full">
    <div id="time_sheet"
        class="method w-full translate-x-full hidden transform transition-transform duration-300 ease-in-out">
        <h1 class="font-semibold mt-3">Add time entery </h1>
        <form id="newTimeSheetForm">
            <div class="grid md:grid-cols-2">
                <div class="relative mt-6 floating-label">
                    <input type="time" id="start_time" name="start_time" required
                        class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                    <label for="start_time"
                        class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                        Start Time
                    </label>
                </div>
                <div class="relative mt-6 floating-label">
                    <input type="time" id="end_time" name="end_time" required
                        class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                    <label for="end_time"
                        class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                        End Time
                    </label>
                </div>
            </div>

            <div class="grid md:grid-cols-2">
                <div class="relative mt-6 floating-label">
                    <input type="text" id="total_hours" name="total_hours" required disabled
                        class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                    <label for="total_hours"
                        class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                        Total hours
                    </label>
                </div>
                <div class="relative mt-6 floating-label">
                    <input type="date" id="entry_date" name="entry_date" required
                        class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                    <label for="entry_date"
                        class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                        Entry Date
                    </label>
                </div>
            </div>
            <div class="relative mt-6 floating-label">
                <input type="text" id="description" name="description" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="description"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Description<span class="text-red-600">*</span>
                </label>
            </div>

            <div class="my-4">
                <button type="submit" class="border p-3 text-sm border-blue-200 rounded-lg">Submit</button>
            </div>
        </form>
    </div>

    <div id="leave_request"
        class="method flex-1 w-full translate-x-full hidden transform transition-transform duration-300 ease-in-out">
        <h1 class="font-semibold mt-3">Leave Request</h1>
        <form class="space-y-3">
            <div class="grid md:grid-cols-2">
                <div class="mt-5 w-64">
                    <label for="policy_id" class="w-full text-sm text-blue-500">Reason</label>
                    <select
                        class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                        id="policy_id" name="policy_id">
                        <option>--</option>
                    </select>
                </div>
                <div class="mt-5 w-64">
                    <label for="leave_unit" class="w-full text-sm text-blue-500">Leave Type</label>
                    <select
                        class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500"
                        id="leave_unit" name="leave_unit">
                        <option value="days">Days</option>
                        <option value="fn">Half-day (FN)</option>
                        <option value="an">Half-day (AN)</option>
                    </select>
                </div>
            </div>
            <div class="grid md:grid-cols-2" id="leave-dates">
                <div id="calendar-inline"></div>
                <div class="mt-4 text-xs text-textPrimary">
                    <label class="w-full">
                        <h6>Start Date</h6>
                        <input type="text" id="start_date" name="start_date" disabled
                            class="bg-transparent border-b w-64 mb-3" />
                    </label>
                    <label class="w-full">
                        <h6>End Date</h6>
                        <input type="text" id="end_date" name="end_date" disabled
                            class="bg-transparent border-b w-64 mb-3" />
                    </label>
                    <label class="w-full">
                        <h6>Total Days</h6>
                        <input type="text" id="total_days" name="total_days" disabled
                            class="bg-transparent border-b w-64 mb-3" />
                    </label>
                </div>
            </div>

            <div class="relative mt-6 floating-label">
                <input type="text" id="description" name="description" required
                    class="peer w-64 border-b-2 border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
                <label for="description"
                    class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
                    Description<span class="text-red-600">*</span>
                </label>
            </div>
            <div class="flex justify-end gap-6">
                <button type="submit" class="border p-3 text-sm border-blue-200 rounded-lg">Submit</button>
            </div>
        </form>

    </div>
</div>
<script>
    $(function () {
        let TimeSheet = []

        $(document).on("click", "#main #section-content #section-entry .actionBtn", function () {
            $("#main #section-content #section-entry .actionBtn").removeClass("bg-gradient-to-r text-white")
            $("#main #section-content #section-entry .actionBtn").addClass("hover:bg-gradient-to-r hover:text-white")
            $(this).removeClass("hover:bg-gradient-to-r hover:text-white")
            $(this).addClass("bg-gradient-to-r text-white")
            showMethodAction($(this).data("method"))
        });

        function showMethodAction(method) {
            $("#main #section-content #section-entry .method").addClass("hidden translate-x-full")
            $(`#main #section-content #section-entry #${method}`).removeClass("hidden")
            setTimeout(() => $(`#main #section-content #section-entry #${method}`).removeClass("translate-x-full"), 30)
            if (method == "time_sheet") {
                TimeSheetCal()
            }
            else {
                MyPolicys()
                datePicker("days")
            }
        }

        function TimeSheetCal() {
            $(document).ready(function () {
                const tnow = new Date()
                let dateDetails = { val: "", min: 0, max: 0 }
                switch (tnow.getDay()) {
                    case 0:
                        dateDetails.min = tnow.setDate(tnow.getDate() - 1)
                        dateDetails.max = tnow.setDate(tnow.getDate());
                        break;
                    case 1:
                        dateDetails.val = tnow.toISOString().split("T")[0];
                        dateDetails.min = tnow.setDate(tnow.getDate());
                        dateDetails.max = tnow.setDate(tnow.getDate() + 1);
                        break;
                    default:
                        dateDetails.val = tnow.toISOString().split("T")[0];
                        dateDetails.min = tnow.setDate(tnow.getDate() - 1);
                        dateDetails.max = tnow.setDate(tnow.getDate() + 2);
                        break;
                }

                $("#main #section-content #section-entry #time_sheet #entry_date").val(dateDetails.val)
                $("#main #section-content #section-entry #time_sheet #entry_date").prop("min", new Date(dateDetails.min).toISOString().split("T")[0])
                $("#main #section-content #section-entry #time_sheet #entry_date").prop("max", new Date(dateDetails.max).toISOString().split("T")[0])

            })
        };

        // New Sheet
        let Start
        let End
        let Totalhours
        let today = new Date().toISOString().split("T")[0];
        // console.log(tnow.getDay())

        $(document).on("change", "#main #section-content #section-entry #time_sheet #start_time", function () {
            Start = $(this).val()
            calculateHours()
        });
        $(document).on("change", "#main #section-content #section-entry #time_sheet #end_time", function () {
            End = $(this).val()
            calculateHours()
        });
        $(document).on("change", "#main #section-content #section-entry #time_sheet #entry_date", function () {
            today = new Date($(this).val()).toISOString().split("T")[0]
            // console.log(today)
            calculateHours()
        });

        function calculateHours() {
            const startTime = new Date(`${today}T${Start}:00`);
            const endTime = new Date(`${today}T${End}:00`);

            let diffMs = endTime - startTime;

            const diffMins = Math.floor(diffMs / (1000 * 60));
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            // Totalhours = parseInt(`${`${hours || 0}`.length<=1?`0${hours}`:`${hours}`}${`${minutes || 0}`.length<=1?`0${minutes}`:`${minutes}`}`)
            Totalhours = hours
            $("#main #section-content #section-entry #time_sheet #total_hours").val(`${hours}h ${minutes}m`)
        }

        // Update Data
        $(document).off("submit", "#main #section-content #section-entry #time_sheet #newTimeSheetForm");
        const month = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
        const d = new Date();
        $(document).on("submit", "#main #section-content #section-entry #time_sheet #newTimeSheetForm", function (e) {
            e.preventDefault();
            if (Totalhours <= 0) {
                $("#main #section-content #section-entry #time_sheet #end_time").focus()
                $("#main #section-content #section-entry #time_sheet #end_time").val("")
                showAlertMessage("info", "Timesheet", "total hours not a negative")
            } else {
                let formData = new FormData(this);
                let data = {};
                let requestId = $(this).attr("index")
                formData.forEach((val, key) => {
                    if (key.includes("time"))
                        data[key] = new Date(`${today}T${val}:00`).getTime()
                    else if (key == "entry_date")
                        data[key] = new Date(val).getTime()
                    else
                        data[key] = val;
                });
                data["total_hours"] = Totalhours
                data["entry_month"] = month[d.getMonth()]
                data["entry_year"] = `${d.getFullYear()}`
                // console.log(data)
                try {
                    fetch(`${DomainURL}/timesheet`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        body: JSON.stringify(data)
                    })
                        .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                        .then(data => {
                            // console.log(data)
                            if (data.status) {
                                showAlertMessage("success", "Timesheet", "New time entery added")
                                setTimeout(() => initAttendFun(), 200)
                            } else {
                                showAlertMessage("error", "Timesheet", data.message)
                            }
                            $(this)[0].reset()
                        });

                } catch (error) {
                    showAlertMessage("warning", "API error", error)
                }

            }
        });

        // Leave Request

        async function MyPolicys(userID) {
            try {
                fetch(`${DomainURL}/timesheet/mypolicy`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            $("#main #section-content #section-entry #leave_request #policy_id").empty()
                            $("#main #section-content #section-entry #leave_request #policy_id").prepend(`
                        <option selected value="0">Others</option>
                    `)
                            data.policy.forEach(element => {
                                if (element.active)
                                    $("#main #section-content #section-entry #leave_request #policy_id").prepend(`
                        <option value="${element.id}">${capitalizeFirstLetter(element.name)}</option>
                    `)
                            })
                        }
                    })
            } catch (error) {
                showAlertMessage("warning", "API error", error)
            }
        }


        $(document).on("change", "#main #section-content #section-entry #leave_request #leave_unit", function () {
            let unit = $(this).val()
            document.getElementById('calendar-inline').innerHTML = ''
            datePicker(unit)
            $("#main #section-content #section-entry #leave_request #leave-dates input").val("")
        })

        function datePicker(unit) {
            const picker = new Litepicker({
                element: document.getElementById('calendar-inline'),
                inlineMode: true,
                singleMode: false,
                numberOfMonths: 1,
                minDays: 1,
                maxDays: unit == "days" ? null : 1,
                numberOfColumns: 1,
                autoApply: true,
                setup: (picker) => {
                    picker.on('selected', (start, end) => {
                        const days = end.diff(start, 'days') + 1;
                        var d = unit == "days" ? days + "/" + unit : 0.5 + `/day(${unit})`
                        $("#main #section-content #section-entry #leave_request #total_days").val(d)
                        $("#main #section-content #section-entry #leave_request #start_date").val(start.dateInstance.toLocaleDateString())
                        $("#main #section-content #section-entry #leave_request #end_date").val(end.dateInstance.toLocaleDateString())

                    });
                }
            });
        }

        $(document).on("submit", "#main #section-content #section-entry #leave_request form", function (e) {
            e.preventDefault();

            let formData = $(this);
            let data = {};
            let flag = true
            data["policy_id"] = parseInt(formData.find("#policy_id").val()) || null
            data["description"] = formData.find("#description").val()
            data["leave_unit"] = formData.find("#leave_unit").val()
            
            let ttD = parseFloat(formData.find("#total_days").val())
            let [sd,sm,sy] = formData.find("#start_date").val().split("/")
            let [ed,em,ey] = formData.find("#end_date").val().split("/")
            if(!(ttD)){
                flag = false
                showAlertMessage("warning","Leave Request","Select leave days")
            }else{
                data["total_days"] = ttD
                data["start_date"] = new Date(sy,sm-1,sd).getTime()
                data["end_date"] = new Date(ey,em-1,ed).getTime()
            }
            // console.log(data,ttD)
            if(flag){
                try {
                    fetch(`${DomainURL}/timesheet/leave`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        method: "POST",
                        body: JSON.stringify(data)
                    })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning","API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        if (data.status) {
                            showAlertMessage("success","Leave Request","Leave request made successfully")
                            setTimeout(() => initAttendFun(), 200)
                        } else {
                            showAlertMessage("error","Leave Request",data.message)
                        }
                    });
                } catch (error) {
                    showAlertMessage("warning","API error", error)
                }
                $(this)[0].reset()
            }


        });


    })
</script>