<!-- Profile Section -->
<div class="tab-section">
    <form id="tab-profile" class="space-y-6">
    </form>
</div>

<script>
    $(function () {
        // floatingInputTag(type,id,name,labelName,value)
        $("form#tab-profile").html(`
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex pl-4">
                    <label class="cursor-pointer relative">
                        <div class="w-24 h-24 rounded-full overflow-hidden border border-gray-300 shadow">
                            <img id="profileImage" 
                                src="" 
                                alt="Profile" 
                                class="object-cover w-full h-full">
                        </div>
                        <input type="file" id="uploadInput" class="hidden" accept="image/*">
                        <input type="hidden" id="fileID" value="0">
                    </label>
                    <div class="toggle flex items-start gap-2 w-fit h-fit hidden" id="removeImage">
                        <i class="fa-solid fa-user-xmark cursor-pointer"></i>
                        <div class="flex items-center hidden" id="toggle-message">
                            <i class="fa-solid fa-caret-left text-gray-500 "></i>
                            <span class="text-white text-xs bg-gray-500  p-1 rounded-lg">Undo</span>
                        </div>
                    </div>
                </div>

                ${floatingInputTag("text", "email", "email", "Email", "", false, true)}
                ${floatingInputTag("text", "first_name", "first_name", "First Name")}
                ${floatingInputTag("text", "last_name", "last_name", "Last Name")}
                ${floatingInputTag("number", "phone", "phone", "Phone")}
                ${floatingInputTag("date", "dob", "dob", "Date of Birth")}
                <div class="w-64 mt-5">
                    <label class="w-full text-sm text-blue-500">Gender</label>
                    <select id="gender" name="gender" class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500">
                        <option>--</option>
                        <option selected value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                ${floatingInputTag("text", "address", "address", "Address")}
                ${floatingInputTag("text", "city", "city", "City")}
                ${floatingInputTag("text", "state", "state", "State")}
                ${floatingInputTag("text", "country", "country", "Country")}
                ${floatingInputTag("text", "pincode", "pincode", "Pincode")}
            </div>
            <div class="flex space-x-2 justify-end">
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Save</button>
            </div>
        `)
        function initFun() {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/my/profile`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        if (data.status) {
                            $(`#tab-profile #email`).val(data.user.email);
                            Object.keys(data.user.profile).forEach((key) => {
                                $(`#tab-profile #${key}`).val(data.user.profile[key]);
                            });
                            SetProfileImage(data.user.profile.profile_image)
                        } else {
                            showAlertMessage("error", "Profile", data.message)
                        }
                        ProgressLoading(false)
                        setAgeLimit()
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }


            setTimeout(() => {
                if (MyOnboardDetails?.correction_marked)
                    MarkCorrection()
            }, 500)
        };

        function setAgeLimit(){
            let now = new Date()
            now.setFullYear(now.getFullYear()-18)
            $("form#tab-profile input#dob").prop("max",now.toISOString().split("T")[0])
        }

        $(document).on("keyup","form#tab-profile input[name=phone]",function(){
            if($(this).val().length > 10){
                $(this).val($(this).val().slice(0,10))
            }
        });

        let MyProfileURL = "./static/image/profile-upload.png"
        let newProfileImg = null
        let newURL
        async function SetProfileImage(params) {
            let image = params
            if (image.id) {
                MyProfileURL = await FilePreviewURL(image.file_path, false)
                $(`#tab-profile input#fileID`).val(image.id)
            }
            $(`#tab-profile img#profileImage`).prop("src", `${MyProfileURL}`)
        }

        $(document).on("change", "form#tab-profile #uploadInput", function () {
            let file = $(this)[0].files[0]
            if (file.name) {
                newProfileImg = file
                newURL = URL.createObjectURL(file)
                $(`#tab-profile img#profileImage`).prop("src", `${newURL}`)
                $(`#tab-profile div#removeImage`).removeClass("hidden")
            } else {
                showAlertMessage("info", "Employee profile", "Error to extract image.")
            }
        })

        $(document).on("click", "div#removeImage i", function () {
            $(`#tab-profile img#profileImage`).prop("src", `${MyProfileURL}`)
            newProfileImg = null
            URL.revokeObjectURL(newURL)
            $("form#tab-profile #uploadInput").val("")
            $(this).parent().addClass("hidden")
        });

        // Form Sumbit
        $(document).ready(function () {
            setAgeLimit()
            initFun();
            $(document).off("submit", "form#tab-profile");
            $(document).on("submit", "form#tab-profile", function (e) {
                e.preventDefault();
                let formData = new FormData(this);
                let data = {};
                formData.forEach((val, key) => {
                    data[key] = val;
                });
                try {
                    ProgressLoading(true)
                    fetch(`${DomainURL}/my/profile`, {
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${access_token}`
                        },
                        method: "PUT",
                        body: JSON.stringify(data)
                    })
                        .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                        .then(data => {
                            if (data.status) {
                                showAlertMessage("success", "Employee profile", "profile saved")
                                UploadProfileImage()
                            } else {
                                showAlertMessage("error", "Employee profile", data.message)
                            }
                            ProgressLoading(false)
                        })
                } catch (error) {
                    ProgressLoading(false)
                    showAlertMessage("warning", "API error", error)
                }

            });
        });

        function UploadProfileImage() {
            if (newProfileImg) {
                let form = new FormData()
                let ID = $("#tab-profile input#fileID").val()
                let fileData = $(`#tab-profile input#uploadInput`)[0].files[0]
                let nameData = userName
                form.append("module_type", "user_profiles")
                form.append("type", "profile")
                form.append("name", nameData + "_profile")
                form.append("file", fileData)

                uploadFileData(ID, form, "Employee profile updated")
            }
        }

        // Toggle function
        $("div.toggle").mouseenter(function () {
            $(this).find("#toggle-message").removeClass("hidden")
        }).mouseleave(function () {
            $(this).find("#toggle-message").addClass("hidden")
        })

        // Mark Correction  function
        function MarkCorrection() {
            let MyProfile = MyOnboardDetails?.correction_note.profile
            let child = $("form#tab-profile").children()
            let arr = Object.keys(MyProfile)
            if (arr.length) {
                arr.forEach(key => {
                    $(child[0]).find(`[name=${key}]`).addClass("border-red-400")
                })
            }
        }
    });
</script>