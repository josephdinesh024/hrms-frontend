<!-- Education Section -->
<div class="mb-6 text-sm">
        <h2 class="text-lg font-semibold">Education</h2>
        <button onclick="toggleNote()" class="text-blue-600 hover:underline flex items-center space-x-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />
            </svg>
            <span>Note</span>
        </button>
        <div id="noteBox" class="mt-2 hidden text-blue-700 p-3">
            <ul class="list-disc ml-5 space-y-1">
                <li>Enter your Degree name (e.g., B.Sc, M.Tech, MBA).</li>
                <li>Provide the Institution/University name.</li>
                <li>Select Mark type (CGPA/Percentage) and enter your score.</li>
                <li>Choose your Start year and End year of study.</li>
                <li>Upload a clear scanned copy of your Marksheet (PDF).</li>
                <!-- <li>Ensure details are correct before submission.</li> -->
            </ul>
        </div>
</div>
<div id="tab-education" class="tab-section">

</div>

<script>
    $(function () {
        // floatingInputTag(type,id,name,labelName,placeholder="",value="",required=true)
        $("#tab-education").html(`
            <form id="education-container" class="space-y-3">
                <div class="border rounded-lg p-4 w-full education-details">
                    <input type="hidden" name="EducationID" id="1_EducationID" value="0" />
                    ${floatingInputTag("text", "1_degree", "degree", "Degree")}
                    ${floatingInputTag("text", "1_institution", "institution", "Institution")}                    
                    <div class="flex items-center gap-2 mb-3">
                        <div class="grid grid-cols-2 gap-6">
                            <select class="mt-5 border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500" required
                                id="1_mark_type" name="mark_type">
                                <option selected value="mark">Mark</option>
                                <option value="grade">Grade</option>
                            </select>
                            ${floatingInputTag("text", "1_percentage", "percentage", "Percentage")}
                        </div>
                        <div class="grid grid-cols-2 gap-6 mt-4">
                            ${SelectionTag("1_start_year", "start_year", "Start year", "--", true, years)}
                            ${SelectionTag("1_end_year", "end_year", "End year", currentYear, true, years)}
                            <span id="1_yearErrorMessage" class="text-xs text-red-400"></span>
                        </div>
                    </div>
                    <div class="md:w-72 flex gap-6">
                    ${floatingFileInputTag('1_file', 'file', 'Upload Marksheet',"",true,[".pdf"])}
                    ${MoreInfo("left","Upload Mark sheet or TC.")}
                    </div>
                </div>
            </form>
            <button type="button" onclick="addEducation()" class="mt-4 text-blue-600 hover:underline">+ Add More</button>
            <div class="flex space-x-2 justify-end">
                <button type="button" id="SaveEducationBtn"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Save</button>
            </div>
        `)
        let UserEductaion = []
        function initFun() {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/my/education`, {
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    method: "GET"
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        if (data.status) {
                            // console.log(data)
                            UserEductaion = data.education
                            if (UserEductaion.length) {
                                $("#tab-education #education-container").empty()
                                UserEductaion.forEach((item, index) => {
                                    $("#tab-education #education-container").append(`
                                    <div class="border rounded-lg p-4 w-full education-details">
                                        <input type="hidden" name="EducationID" id="${index + 1}_EducationID" value="${item.id}" />
                                        ${floatingInputTag("text", `${index + 1}_degree`, "degree", "Degree", value = item.degree)}
                                        ${floatingInputTag("text", `${index + 1}_institution`, "institution", "Institution", value = item.institution)}
                                        <div class="flex items-center gap-2 mb-3">
                                            <div class="grid grid-cols-2 gap-6">
                                                <select class="mt-5 border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500" required
                                                    id="${index + 1}_mark_type" name="mark_type">
                                                    <option ${item.mark_type == "mark" && "selected"} value="mark">Mark</option>
                                                    <option ${item.mark_type == "grade" && "selected"}  value="grade">Grade</option>
                                                </select>
                                                ${floatingInputTag("text", `${index + 1}_percentage`, "percentage", "Percentage", value = item.percentage)}
                                            </div>
                                            <div class="grid grid-cols-2 gap-6 mt-4">
                                                ${SelectionTag(`${index + 1}_start_year`, "start_year", "Start year", value = item.start_year, true, years)}
                                                ${SelectionTag(`${index + 1}_end_year`, "end_year", "End year", value = item.end_year, true, years)}                                                
                                                <span id="${index + 1}_yearErrorMessage" class="text-xs text-red-400"></span>
                                            </div>
                                        </div>
                                        <div class="md:w-72 flex gap-6">
                                        <div>
                                        ${floatingFileInputTag(index + 1 + '_file', 'file', 'Upload Certificate', item?.file.file_path.split("/").pop(), false,[".pdf"])}
                                        <span onclick="FilePreviewURL('${item.file.file_path}')" class="text-sm text-blue-400 cursor-pointer">Preview</span>
                                        </div>
                                        ${MoreInfo("left","Upload Mark sheet or TC.")}
                                        </div>
                                    </div>
                                `);
                                });
                                divID = UserEductaion.length + 1
                            }

                        } else {
                            console.log(data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }

            if (MyOnboardDetails?.correction_marked) {
                setTimeout(() => MarkCorrection(), 500)
            }
        }
        initFun()

        $(document).on("change", `#tab-education #education-container select[name="start_year"]`, function () {
            let FormID = $(this).attr("id").split("_")[0]
            stYr = parseInt($(this).val());
            edYr = parseInt($(`#tab-education #education-container #${FormID}_end_year`).val());
            if (edYr && edYr - stYr >= 1) {
                $(`#tab-education #education-container #${FormID}_yearErrorMessage`).text("")
                $(`#tab-education #SaveEducationBtn `).prop("disabled", false)
            } else {
                $(`#tab-education #education-container #${FormID}_yearErrorMessage`).text("Invalid date range")
                $(`#tab-education #SaveEducationBtn `).prop("disabled", true)
            }

        })

        $(document).on("change", `#tab-education #education-container select[name="end_year"]`, function () {
            let FormID = $(this).attr("id").split("_")[0]
            edYr = parseInt($(this).val());
            stYr = parseInt($(`#tab-education #education-container #${FormID}_start_year`).val());
            if (stYr && edYr - stYr >= 1) {
                $(`#tab-education #education-container #${FormID}_yearErrorMessage`).text("")
                $(`#tab-education #SaveEducationBtn `).prop("disabled", false)
            } else {
                $(`#tab-education #education-container #${FormID}_yearErrorMessage`).text("Invalid date range")
                $(`#tab-education #SaveEducationBtn `).prop("disabled", true)
            }

        });

        $(document).on("keyup click","#tab-education input[name=percentage]",function(){
            let id = $(this).attr("id")
            let val = $(this).val()
            let etVal = val.split(".")
            let edNum = id.split("_")[0]
            let mkType = $(`#tab-education select#${edNum}_mark_type`).val()
            let num = mkType === "mark" ? etVal[0] == 100 ? etVal[0] : etVal[0].slice(0,2) : etVal[0] == 10 ? etVal[0] : etVal[0].slice(0,1)
            let flt = etVal.length == 2 ? etVal[1] != "" ? "."+etVal[1].slice(0,2) : "." : ""   
            $(this).val(`${num}${flt}`)
        })

        $(document).off("click", "#tab-education button#SaveEducationBtn");
        $(document).on("click", "#tab-education button#SaveEducationBtn", function (e) {
            let invalidFields = $("form:invalid");
            if (invalidFields?.length) {
                showAlertMessage("warning", "Employee profile", "Fill required fields to continue.")
            } else {
                let childrens = $("#tab-education #education-container div.education-details");
                for (let i = 0; i < childrens.length; i++) {
                    let form = new FormData()
                    let data = childrens[i]
                    let ID = $(data).find("input[name=EducationID]").val()
                    let institutionData = $(data).find("input[name=institution]").val()
                    let degreeData = $(data).find("input[name=degree]").val()
                    let mark_typeData = $(data).find("select[name=mark_type]").val()
                    let percentageData = $(data).find("input[name=percentage]").val()
                    let start_yearData = $(data).find("select[name=start_year]").val()
                    let end_yearData = $(data).find("select[name=end_year]").val()
                    let fileData = $(data).find("input[name=file]")[0].files[0]
                    if (start_yearData == "--" || end_yearData == "--") {
                        $(`#tab-education #education-container #${i + 1}_yearErrorMessage`).text("Invalid date range")
                        $(`#tab-education #SaveEducationBtn `).prop("disabled", true)
                        showAlertMessage("warning", "Education Years", "Invalid date range")
                    } else {
                        // console.log(institutionData,degreeData)
                        form.append("institution", institutionData)
                        form.append("degree", degreeData)
                        form.append("mark_type", mark_typeData)
                        form.append("percentage", percentageData)
                        form.append("start_year", start_yearData)
                        form.append("end_year", end_yearData)
                        form.append("upload_file", fileData)
                        // console.log(mark_typeData)
                        UploadEductionData(ID, form, i)
                    }
                }
            }
        });

        async function UploadEductionData(ID, form, index) {
            try {
                ProgressLoading(true)
                fetch(`${DomainURL}/my/education${ID != "0" ? "/" + ID : ""}`, {
                    headers: {
                        Authorization: `Bearer ${access_token}`
                    },
                    method: ID != 0 ? "PUT" : "POST",
                    body: form
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        if (data.status) {
                            $(`#tab-education #education-container #${index + 1}__EducationID`).val(data.education.id)
                            // console.log(data)
                            showAlertMessage("success", "Employee profile", "Education details saved")
                        } else {
                            showAlertMessage("error", "Employee profile", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }
        };

        // Mark Correction  function
        function MarkCorrection() {
            let MyEduction = MyOnboardDetails?.correction_note.education
            let child = $("#tab-education #education-container").children()
            MyEduction.forEach((crt, i) => {
                let arr = Object.keys(crt)
                if (arr.length) {
                    arr.forEach(key => {
                        if(key == "file")
                            $(child[i]).find(`[name=file]`).parent().find("div").addClass("border-red-400")
                        else
                            $(child[i]).find(`[name=${key}]`).addClass("border-red-400")
                    })
                }
            })
        }
    });
</script>