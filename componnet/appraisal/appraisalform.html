<div id="filterAction" class="max-w-1/4 min-w-fit min-h-full bg-gray-50 p-6 border-r flex flex-col justify-between">
  <button id="AddNewForm" onclick="OpenNewEmployeeForm()"
    class="text-sm font-medium hover:font-bold hover:text-blue-600">
    <i class="fa-solid fa-plus"></i> Add form
  </button>
  <div class="flex gap-2 items-center text-md px-2">
    <button id="previous"><i class="fa-solid fa-circle-chevron-left"></i></button>
    <span id="countMessage">5 of 10</span>
    <button id="next"><i class="fa-solid fa-circle-chevron-right"></i></button>
  </div>
</div>
<hr>
<div id="formCardList" class="w-full">
  <table class="w-full border-collapse text-xs">
    <thead>
      <tr class="bg-gray-100 text-gray-700 text-left">
        <th class="p-4 border-b">Title</th>
        <th class="p-4 border-b">Question</th>
        <th class="p-4 border-b">Type</th>
        <th class="p-4 border-b">Open time</th>
        <th class="p-4 border-b">Close time</th>
        <th class="p-4 border-b">Status</th>
      </tr>
    </thead>
    <tbody>

    </tbody>
  </table>
</div>

<div id="formModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-5xl h-5/6 shadow-lg overflow-auto">
    <h2 class="text-xl font-bold mb-4">Create Appraisal Form</h2>

    <form id="appraisalForm" class="grid md:grid-cols-2 gap-4">
      <div class="relative mt-6 floating-label w-full">
        <input type="text" id="title" name="title" required
          class="peer border-b-2 w-full border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
        <label for="title"
          class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
          Appraisal Form Title
        </label>
      </div>
      <div class="mt-8">
        <label for="type" class="w-full text-sm text-blue-500">Appraisal Form Type</label>
        <select id="type" name="type"
          class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500">
          <option value="all">All</option>
          <option value="role">Role</option>
        </select>
      </div>
      <div class="mt-8 hidden">
        <label for="role_id" class="w-full text-sm text-blue-500">Role</label>
        <select id="role_id" name="role_id"
          class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500">
          <option value="">--</option>
        </select>
      </div>
      <div class="relative mt-6 floating-label w-full">
        <input type="date" id="start_time" name="start_time" required
          class="peer border-b-2 w-full border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
        <label for="start_time"
          class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
          Form Open Date
        </label>
      </div>
      <div class="relative mt-6 floating-label w-full">
        <input type="date" id="end_time" name="end_time" required
          class="peer border-b-2 w-full border-gray-300 bg-transparent text-sm pt-8 focus:py-4 focus:outline-none focus:border-blue-500" />
        <label for="end_time"
          class="absolute left-0 text-gray-500 text-sm transition-all duration-200 peer-[:valid]:top-4 peer-[:valid]:text-blue-600">
          Form Due Date
        </label>
      </div>
      <div class="mt-8">
        <label for="status" class="w-full text-sm text-blue-500">Appraisal Form Status</label>
        <select id="status" name="status"
          class="w-full border-b-2 border-gray-300 bg-transparent text-sm focus:outline-none focus:border-blue-500">
        </select>
      </div>
      <div class="my-6 col-span-2">
        <label class="block text-sm font-medium">Questions</label>
        <div id="questionList" class="space-y-2 mt-2">
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-2 mt-6 col-span-2">
        <button type="button" onclick="closeModal()" class="bg-gray-50 hover:bg-gray-300 font-semibold text-xs py-2 px-8 shadow-sm shadow-third rounded-lg mr-2">Cancel</button>
        <button id="appraisalFormSaveBtn" type="submit"
          class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                            hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500 mr-2">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  $(function () {
    let page = 1
    let paseSize = PAGESIZE
    let TotalCount = 0
    let forms = []
    let categories = FormCategories
    let roleList = []
    let selectedFormID = 0

    function initFetch() {
      $("#editPanel #editContent").empty()
      closePanel()
      try {
        ProgressLoading(true)
        fetch(`${DomainURL}/appraisal/form?page=${page}&page_size=${paseSize}`, {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${access_token}`
          },
          method: "GET"
        })
          .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
          .then(data => {
            // console.log(data)
            if (data.status) {
              selectedFormID = 0
              $("#formCardList tbody").empty()
              forms = data.appraisal_form
              if (forms.length)
                forms.forEach((element, index) => {
                  $("#formCardList tbody").append(`
                                <tr id="${index}" class="border-b hover:bg-gray-50 transition selectedList">
                                    <td class="p-4">${capitalizeFirstLetter(element.title)}</td>
                                    <td class="p-4 w-20 overflow-auto">${element.question.length}</td>
                                    <td class="p-4">${capitalizeFirstLetter(element.type)} ${element.role_id && element.type != "all" ? `(${element.role.name})` : ""}</td>
                                    <td class="p-4">${new Date(element.start_time).toLocaleDateString()}</td>
                                    <td class="p-4">${new Date(element.end_time).toLocaleDateString()}</td>
                                    <td class="p-4">
                                        ${StatusColourCode(element.status)}
                                    </td>
                                </tr>
                            `)

                });
              TotalCount = data.total_count
              var total = (page - 1) * paseSize
              $("#countMessage").text(`${total + forms.length} of ${TotalCount}`)
            }
            ProgressLoading(false)
          });

      } catch (error) {
        ProgressLoading(false)
        showAlertMessage("warning", "API error", error)
      }

      try {
        ProgressLoading(true)
        fetch(`${DomainURL}/role?page_size=50`, {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${access_token}`
          },
          method: "GET"
        })
          .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
          .then(data => {
            if (data.status) {
              // console.log(data)
              data.roles.forEach(element => {
                // if (element.active)
                $("#formModal #role_id").append(`<option value="${element.id}">${capitalizeFirstLetter(element.name)}</option>`)
              })
            }
            ProgressLoading(false)
          });
      } catch (error) {
        ProgressLoading(false)
        showAlertMessage("warning", "API error", error)
      }

    }
    $(document).ready(function(){
      $("#formModal #appraisalForm #status").append(`
            <option value=${3}>${statusNames[3]}</option>
            <option value=${4}>${statusNames[4]}</option>
            `)
      initFetch()
    })

    $(document).on("click", "button#previous", function () {
      if (page != 1) {
        page -= 1
        initFetch()
      }
    })

    $(document).on("click", "button#next", function () {
      let check = TotalCount - (paseSize * page)
      if (check > 0) {
        page += 1
        initFetch()
      }
    })

    let questionListData = []
    // New
    $(document).on("click", "#formCardList tbody .selectedList", function () {
      let index = $(this).attr("id")
      let selectedForm = forms[index]
      selectedFormID = selectedForm.id
      questionListData = []
      $("#formModal").removeClass("hidden");
      $("#formModal form")[0].reset();

      let sDate = new Date(selectedForm.start_time)
      let eDate = new Date(selectedForm.end_time)
      let currDate = new Date
      if (sDate <= currDate && currDate <= eDate) {
        $("#appraisalFormSaveBtn").hide()
      } else {
        $("#appraisalFormSaveBtn").show()
      }
      $(document).ready(function () {
        $("#formModal #appraisalForm #title").val(selectedForm.title);
        $("#formModal #appraisalForm #type").val(selectedForm.type);
        $("#formModal #appraisalForm #role_id").val(selectedForm.role_id);
        $("#formModal #appraisalForm #status").val(selectedForm.status);
        $("#formModal #appraisalForm #start_time").val(sDate.toISOString().split("T")[0]);
        $("#formModal #appraisalForm #end_time").val(eDate.toISOString().split("T")[0]);
        $("#formModal #questionList").empty()
        $("#formModal #questionList").append(`
              ${categories.map((items, index) => {
          return `<div class="w-full p-2 bg-white hover:shadow-sm hover:border-b-2 categorys">
                    <label for="${index}" class="w-full flex gap-3 cursor-pointer" >
                      <input id="${index}" ${selectedForm.question.find(item => {
            if (item.index == index) {
              questionListData.push({ index: item.index, question: item.question })
              return true
            }
            else
              return false
          }) ? "checked" : ""} type="checkbox" class="questionSelect"/>
                      <h5>${index + 1}) ${items}</h5>
                    </label>
                  </div>`
        }).join("")}
          `)
      });

    });

    // Add Form
    $(document).on("click", "#filterAction #AddNewForm", function () {
      document.getElementById("formModal").classList.remove("hidden");
      selectedFormID = 0
      questionListData = []
      $("#appraisalFormSaveBtn").show()
      $("#formModal #questionList").append(`
            ${categories.map((items, index) => {
        return `<div class="w-full p-2 bg-white hover:shadow-sm hover:border-b-2 categorys">
                  <label for="${index}" class="w-full flex gap-3 cursor-pointer" >
                    <input id="${index}" type="checkbox" class="questionSelect"/>
                    <h5>${index + 1}) ${items}</h5>
                  </label>
                </div>`
      }).join("")}
        `)
    })

    $(document).on("change", "#formModal select#type", function () {
      let val = $(this).val()
      let parent = $("#formModal select#role_id").parent()

      val == "role" ? parent.removeClass("hidden") : parent.addClass("hidden")
    })

    $(document).on("change", "#formModal #questionList input.questionSelect", function (e) {
      let index = $(this).attr("id")
      // console.log($(this).val())
      if (e.target.checked)
        questionListData.push({ index, question: categories[index] })
      else
        questionListData = questionListData.filter(items => items.index != index)
    });

    $(document).on("submit", "#formModal #appraisalForm", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const payload = {
        title: formData.get("title"),
        start_time: new Date(formData.get("start_time")).getTime(),
        end_time: new Date(formData.get("end_time")).getTime(),
        type: formData.get("type"),
        question: questionListData,
        role_id: formData.get("type") == "all" ? null : parseInt(formData.get("role_id")),
        status: parseInt(formData.get("status"))
      };
      // console.log(payload)
      try {
        ProgressLoading(true)
        await fetch(`${DomainURL}/appraisal/form${selectedFormID ? "/" + selectedFormID : ""}`, {
          method: selectedFormID ? "PUT" : "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${access_token}`
          },
          body: JSON.stringify(payload),
        })
          .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
          .then(data => {
            if (data.status) {
              showAlertMessage("success", "Appraisal form", `Appraisal Form ${selectedFormID ? "Updated" : "Created"} Successfully`);
              initFetch()
              closeModal();
            } else {
              // console.log(data.message)
              showAlertMessage("error", "Appraisal form", `Failed to ${selectedFormID ? "update" : "create"} form`);
            }
            ProgressLoading(false)
          })
      } catch (error) {
        ProgressLoading(false)
        showAlertMessage("warning", "API error", error)
      }
    });

  })

  function closeModal() {
    document.getElementById("formModal").classList.add("hidden");
    $("#formModal form")[0].reset();
    document.getElementById("questionList").innerHTML =
      '';
  }
</script>