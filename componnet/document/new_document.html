<div class="p-6">
    <form id="newDocumentForm">

    </form>
</div>

<script>
    $(function(){
        let Template
        $(document).ready(function(){
            $("form#newDocumentForm").html(`
                <h3 class="text-xl font-medium">Document Open Form</h3>
                <div class="grid md:grid-cols-2 gap-6 md:w-3/4 mb-5">
                    ${floatingInputTag("text", "name", "name", "Document Name")}
                    ${SelectionTag("template_id", "template_id", "Document Template")}
                    ${SelectionTag("assign", "assign", "Document Open to","role",true,["role","employee"])}
                    ${SelectionTag("role_id", "role_id", "Role")}
                    ${SelectionTag("user_id", "user_id", "Employee")}
                    ${floatingInputTag("text", "description", "description", "Document Description","",false)}
                    <div class="relative mt-6 text-textPrimary w-full border-b-2 border-gray-300 bg-transparent text-sm pt-4 pb-1 focus:outline-none focus:border-blue-500">
                        <input
                            type="checkbox"
                            id="file_upload"
                            class="peer"
                            name="file_upload"
                        />
                        <label
                            for="file_upload"
                            class="peer-[:checked]:text-blue-400"
                        >
                            Documenr Re-upload
                        </label>
                    </div>
                    ${SelectionTag("status", "status", "Document Status","",true,[])}
                </div>
                <div class="my-4 flex">
                    <button type="submit"
                        class="py-2 px-8 shadow-sm shadow-third rounded-lg font-semibold text-third text-xs 
                                    hover:bg-gradient-to-r from-primary from-5% to-blue-800 hover:text-white transition-all duration-500">Save</button>
                </div>
            `)
            ChangeAssing("role")
            $("form#newDocumentForm [name=status]").append(`
            <option value=${1}>${statusNames[1]}</option>
            <option value=${2}>${statusNames[2]}</option>
            `)
            $("form#newDocumentForm [name=status]").closest("div").hide()
            SelectOptios("role","roles","name","select[name=role_id]")
            SelectOptios("user","user","user_name","select[name=user_id]")
            SelectOptios("document/template","template","name","select[name=template_id]")
            if(SelectedID)
                setTimeout(()=>DocumentInit(),300)
        });

        $(document).on("change","select[name=assign]",function(){ChangeAssing($(this).val())})

        function ChangeAssing(val){
            if(val == "employee"){
                $("form#newDocumentForm [name=role_id]").closest("div").hide()
                $("form#newDocumentForm [name=user_id]").closest("div").show()
            }else{
                $("form#newDocumentForm [name=role_id]").closest("div").show()
                $("form#newDocumentForm [name=user_id]").closest("div").hide()
            }
        }

        // $(document).off("submit","form#newDocumentForm")
        $(document).on("submit","form#newDocumentForm",function(e){
            e.preventDefault()
        let formData = new FormData(this)
        let data = {}
        data["name"] = formData.get("name")
        data["descrition"] = formData.get("descrition")
        data["template_id"] = parseInt(formData.get("template_id"))
        formData.get("assign") == "employee" ? data["user_id"] = parseInt(formData.get("user_id")) : data["role_id"] = parseInt(formData.get("role_id"))
        data["file_upload"] = formData.get("file_upload") ? true : false
        if(SelectedID)
            data["status"] = parseInt(formData.get("status"))
        if(!data["template_id"])
            showAlertMessage("error","Document","template should not be empty")
        else if(formData.get("assign") == "role" && !data["role_id"])
            showAlertMessage("error","Document","role should not me empty")
        else if(formData.get("assign") == "employee" && !data["user_id"])
            showAlertMessage("error","Document","employee name should not me empty")
        else if(!data["role_id"] && !data["user_id"])
            showAlertMessage("error","Document","Select assing to values")
        else{
            try{
            ProgressLoading(true)
                fetch(`${DomainURL}/document${SelectedID ? "/"+SelectedID : ""}`, {
                    method: SelectedID ? "PUT" : "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                    body: JSON.stringify(data)
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        console.log(data)
                        if (data.status) {
                            showAlertMessage("success", "Document", "Document saved successfully")
                            setTimeout(()=>window.location.href="?",1000)
                        } else {
                            showAlertMessage("error", "Document", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }
        // console.log(data)
        }
    
    })
    })

    function SelectOptios(link,module,key,tagID){
        try{
            ProgressLoading(true)
                fetch(`${DomainURL}/${link}?page_size=100`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${access_token}`
                    },
                })
                    .then(res => res.ok ? res.json() : showAlertMessage("warning", "API error", `${res.status} ${res.statusText}`))
                    .then(data => {
                        // console.log(data)
                        if (data.status) {
                            data[module].forEach(elmt =>{
                                $(tagID).append(`<option value="${elmt.id}">${capitalizeFirstLetter(elmt[key])}</option>`)
                            })
                        } else {
                            showAlertMessage("error", "Document Template", data.message)
                        }
                        ProgressLoading(false)
                    })
            } catch (error) {
                ProgressLoading(false)
                showAlertMessage("warning", "API error", error)
            }
    }
</script>